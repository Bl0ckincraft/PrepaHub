<!doctype html>
<html>
<head>
    <title>PrépaLib{% if block("title") is not empty %} | {% block title %}{% endblock %}{% endif %}</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="La bibliothèque faite pour les prépas.">
    <link rel="icon" href="{{ asset("images/icon.png") }}">
    {% block stylesheets %}
        {{ encore_entry_link_tags('app') }}
    {% endblock %}

    {% block scripts %}
        <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        {{ encore_entry_script_tags('app') }}
        <script>
            MathJax = {
                tex: {
                    inlineMath: [['$', '$']],
                    processEscapes: true,
                    macros: {
                        llbracket: '\\unicode{10214}',
                        rrbracket: '\\unicode{10215}',
                        rg: '\\text{rg}',
                        dim: '\\text{dim}',
                        sup: '\\text{sup}',
                        inf: '\\text{inf}',
                        et: '\\text{ et }'
                    }
                },
                options: {
                    skipHtmlTags: ['script', 'noscript', 'textarea', 'pre']
                }
            };

            // Fonction pour initialiser la prévisualisation LaTeX
            const initLatexPreview = (input) => {
                if (!input) return;

                const id = input.id || `latex-preview-${Math.random().toString(36).substr(2, 9)}`;
                input.id = id;

                let previewContainer = input.nextElementSibling;
                if (!previewContainer || !previewContainer.classList.contains('latex-preview-container')) {
                    previewContainer = document.createElement('div');
                    previewContainer.className = 'latex-preview-container mt-2';
                    previewContainer.innerHTML = `
                <div class="text-sm text-text-300">Prévisualisation :</div>
                <div class="latex-preview p-4 bg-foreground-400 rounded" data-preview-for="${id}"></div>
            `;
                    input.parentNode.insertBefore(previewContainer, input.nextSibling);
                }

                const preview = previewContainer.querySelector('.latex-preview');

                const render = () => {
                    preview.innerHTML = input.value;
                    if (window.MathJax && MathJax.typesetPromise) {
                        MathJax.typesetPromise([preview]);
                    }
                };

                input.addEventListener('input', render);
                render();
            };

            document.addEventListener('DOMContentLoaded', function () {
                // Initialisation des prévisualisations existantes
                document.querySelectorAll('.latex-input').forEach(initLatexPreview);

                // Initialisation automatique des latex preview ajoutées et les latex tout court
                const observer = new MutationObserver((mutations) => {
                    for (const mutation of mutations) {
                        for (const addedNode of mutation.addedNodes) {
                            if (addedNode.nodeType !== Node.ELEMENT_NODE) continue;

                            addedNode.querySelectorAll('.latex-input').forEach(initLatexPreview);
                            MathJax.typesetPromise(addedNode.querySelectorAll('.latex'));
                        }
                    }
                });

                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
            });
        </script>
        <script>
            const ExercisePref = (function() {
                function setPref(exerciseId, data, after = function () {}, afterError = function () {}) { // data example: {"favorite": true}
                    const url = "{{ path('api_set_preference', {'exercise': 'EXERCISE_ID'}) }}".replaceAll('EXERCISE_ID', exerciseId);
                    fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Erreur HTTP : ' + response.status);
                            }

                            return response.json();
                        })
                        .then(data => {
                            updatePrefContainers([data.pref]);
                            after()
                        })
                        .catch(error => {
                            console.error('Erreur fetch :', error); // TODO : NOTIFICATION
                            afterError();
                        });
                }

                function updatePrefContainers(prefs) {
                    for (const pref of prefs) {
                        document.querySelectorAll(`.prefs-${pref.exercise}`).forEach(container => {
                            const doneT = container.querySelector(".done .true");
                            if (pref.done) doneT.classList.remove("hidden!");
                            else doneT.classList.add("hidden!");

                            const doneF = container.querySelector(".done .false");
                            if (pref.done) doneF.classList.add("hidden!");
                            else doneF.classList.remove("hidden!");

                            const favoriteT = container.querySelector(".favorite .true");
                            if (pref.favorite) favoriteT.classList.remove("hidden!");
                            else favoriteT.classList.add("hidden!");

                            const favoriteF = container.querySelector(".favorite .false");
                            if (pref.favorite) favoriteF.classList.add("hidden!");
                            else favoriteF.classList.remove("hidden!");

                            const difficultyContainer = container.querySelector(".difficulty");
                            const unselectedColor = difficultyContainer.dataset.unselectedColor;

                            difficultyContainer.querySelectorAll(".difficulty-element").forEach(element => {
                                const selectedColor = element.dataset.selectedColor;
                                if (parseInt(element.dataset.difficulty) === pref.difficulty) {
                                    element.classList.remove(unselectedColor);
                                    element.classList.add(selectedColor);
                                } else {
                                    element.classList.remove(selectedColor);
                                    element.classList.add(unselectedColor);
                                }
                            })

                            const nonCommentedText = container.querySelector(".non-commented-text");
                            const commentContainer = container.querySelector(".comment-container");

                            if (pref.comment.trim() === "") {
                                nonCommentedText.classList.remove("hidden");
                                commentContainer.classList.add("hidden");
                                commentContainer.innerText = "";
                            } else {
                                nonCommentedText.classList.add("hidden");
                                commentContainer.classList.remove("hidden");
                                commentContainer.innerText = pref.comment;
                            }
                        });
                    }
                }

                return {
                    setPref: setPref
                }
            })
        </script>
    {% endblock %}
</head>
<body class="text-text-100 font-noto-sans bg-background-500 min-h-[100dvh] min-w-[100dvw] p-0 m-0 select-none">
    <twig:Loader />
    {% block body %}
    {% endblock %}
</body>
</html>
